#!/bin/bash

set -Eeuo pipefail

curl -sL 'https://raw.githubusercontent.com/falcosecurity/evolution/8dd473f609f9fb585ca62fbb8951098e279d8dd1/examples/k8s_audit_config/audit-policy.yaml' -o /etc/kubernetes/audit-policy.yaml

# apply falco-webhook-kubeconfig
WEBHOOK=""
echo "$WEBHOOK" | base64 -d >> /etc/kubernetes/audit-webhook-kubeconfig

# add audit flags
PATCH=""
cd /etc/kubernetes/manifests
grep audit-webhook-kubeconfig kube-apiserver.yaml &> /dev/null
if [[ $? -ne 0 ]]; then
    patch -p1 --no-backup-if-mismatch --forward -i <(echo "$PATCH" | base64 -d)
fi

echo 'flag_ctf{ItsOkayYoureSafeTheyCantHearUs}' > /root/flag.txt
chmod 400 /root/flag.txt

## manual cleanup
rm -f /root/.bash_history
journalctl --vacuum-time 1s --quiet 2>/dev/null
