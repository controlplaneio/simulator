#cloud-config

# cri-tools included to ensure we always have crictl
# currently a dependency of kubeadm, which will pull
# in the correct version for us
packages:
  - figlet
  - containerd
  - [cri-tools, 1.25.*]
  - awscli
  - [kubelet, ${version}*]
  - [kubeadm, ${version}*]
  - [kubectl, ${version}*]

hostname: "${hostname}"

write_files:
  - path: /etc/modules-load.d/k8s.conf
    permissions: "0644"
    content: "br_netfilter"
  - path: /etc/sysctl.d/k8s.conf
    permissions: "0644"
    content: |
      net.bridge.bridge-nf-call-iptables = 1
      net.bridge.bridge-nf-call-ip6tables = 1
      net.ipv4.ip_forward = 1

runcmd:
  - "modprobe br_netfilter"
  - "sysctl --load=/etc/sysctl.d/k8s.conf"

  - 'systemctl daemon-reload'
  - 'systemctl enable --now containerd'

  - 'kubeadm init --pod-network-cidr=192.168.0.0/16 --kubernetes-version=stable-${version_major_minor} --token-ttl 15m'
  - 'mkdir /root/.kube'
  - 'cp /etc/kubernetes/admin.conf /root/.kube/config'

  # https://projectcalico.docs.tigera.io/getting-started/kubernetes/requirements#kubernetes-requirements
  - 'kubectl --kubeconfig=/etc/kubernetes/admin.conf apply -f https://raw.githubusercontent.com/projectcalico/calico/v3.24.1/manifests/calico.yaml'

  - "egrep -A 1 '^kubeadm join' /var/log/cloud-init-output.log  | tr -d '\\' | tr -d '\n' > /tmp/join.txt"
  - 'aws s3 cp /tmp/join.txt s3://${s3_bucket_name}'
  - 'aws s3 cp /root/.kube/config s3://${s3_bucket_name}'
  - 'rm -f /tmp/join.txt'
