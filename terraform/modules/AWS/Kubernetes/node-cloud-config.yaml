#cloud-config

# cri-tools included to ensure we always have crictl
# currently a dependency of kubeadm, which will pull
# in the correct version for us
packages:
  - figlet
  - containerd
  - [cri-tools, 1.25.*]
  - awscli
  - [kubelet, ${version}*]
  - [kubeadm, ${version}*]
  - [kubectl, ${version}*]

hostname: "${hostname}"

write_files:
  - path: /etc/modules-load.d/k8s.conf
    permissions: "0644"
    content: "br_netfilter"
  - path: /etc/sysctl.d/k8s.conf
    permissions: "0644"
    content: |
      net.bridge.bridge-nf-call-iptables = 1
      net.bridge.bridge-nf-call-ip6tables = 1
      net.ipv4.ip_forward = 1

runcmd:
  - "modprobe br_netfilter"
  - "sysctl --load=/etc/sysctl.d/k8s.conf"

  - "systemctl daemon-reload"
  - "systemctl enable --now containerd"

  - "while true; do aws s3 ls s3://${s3_bucket_name}/join.txt > /dev/null; if [ $? -ne 0 ]; then sleep 10; else break; fi; done && aws s3 cp s3://${s3_bucket_name}/join.txt /tmp"
  - "if ! sh /tmp/join.txt; then sleep 30; if ! sh /tmp/join.txt; then sleep 90; sh /tmp/join.txt; fi; fi"
  - "rm -f /tmp/join.txt"
