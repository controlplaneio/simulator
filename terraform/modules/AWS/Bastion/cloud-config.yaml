#cloud-config

packages:
  - docker.io
  - figlet

hostname: "bastion"

runcmd:
  # We have to remove access here, as it baked into the Ubuntu AMI
  - "rm /etc/sudoers.d/90-cloud-init-users"
  - "gpasswd -d ubuntu sudo"
  # Setup Docker
  - "systemctl disable --now kubelet"
  - "systemctl enable --now docker"
  - "docker pull ${attack_container_repo}:${attack_container_tag}"

write_files:
  - path: /etc/profile.d/motd.sh
    permissions: "0775"
    content: !!binary |
      ${bastion_motd}
  - path: /opt/bash_login_script
    permissions: "0700"
    owner: root:root
    content: |
      #!/bin/bash
      set -Eeuo pipefail

      export MASTER_IP_ADDRESSES=${master_ip_addresses}
      export NODE_IP_ADDRESSES=${node_ip_addresses}
      export INTERNAL_HOST_IP=${internal_host_private_ip}
      if [[ "$${BASE64_SSH_KEY:-}" == "" ]]; then
        export BASE64_SSH_KEY=$(base64 -w0 /home/ubuntu/.ssh/cp_simulator_rsa)
      fi

      exec docker run -h attack \
        -v /home/ubuntu/progress.json:/progress.json \
        -v /home/ubuntu/tasks.yaml:/tasks.yaml \
        -v /home/ubuntu/challenge.txt:/challenge.txt \
        --net=host \
        -e MASTER_IP_ADDRESSES -e NODE_IP_ADDRESSES -e INTERNAL_HOST_IP \
        -e BASE64_SSH_KEY -e KUBESIM \
        -it ${attack_container_repo}:${attack_container_tag}

  - path: /home/ubuntu/.bash_login
    permissions: "0755"
    content: |
      exec sudo /opt/bash_login_script
  - path: /etc/sudoers.d/bash_login
    permissions: "0600"
    content: |
      ubuntu    ALL=(ALL:ALL) NOPASSWD: /opt/bash_login_script
  - path: /home/ubuntu/progress.json
    permissions: "0666"
    content: "{}"
  - path: /home/ubuntu/challenge.txt
    permissions: "0666"
    content: |
      No scenario instructions found. Have you launched a scenario with 'simulator scenario launch ...'?
  - path: /home/ubuntu/tasks.yaml
    permissions: "0666"
    content: |
      No scenario tasks found. Have you launched a scenario with 'simulator scenario launch ...'?
  - path: /etc/ssh/sshd_config.d/bastion.conf
    permissions: "0640"
    content: |
      # Allow SendEnv of BASE64_SSH_KEY to enable SSHing to the instances in the
      # private subnet (the kubernetes master and nodes)
      AcceptEnv BASE64_SSH_KEY LANG LC_*
      # Hardening
      X11Forwarding no
      Subsystem sftp /bin/false
